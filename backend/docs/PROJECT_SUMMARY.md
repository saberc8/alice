# Alice RBAC æƒé™ç®¡ç†ç³»ç»Ÿ - é¡¹ç›®æ€»ç»“

## é¡¹ç›®æ¦‚è¿°

åŸºäºGoè¯­è¨€å®ç°çš„å®Œæ•´RBAC(åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶)æƒé™ç®¡ç†ç³»ç»Ÿï¼Œæ”¯æŒç”¨æˆ·ã€è§’è‰²ã€æƒé™å’Œèœå•çš„ç²¾ç¡®æ§åˆ¶ï¼Œå¯ä»¥ç²¾ç¡®åˆ°é¡µé¢æŒ‰é’®çº§åˆ«çš„æƒé™ã€‚ä¸¥æ ¼éµå¾ªDDD(é¢†åŸŸé©±åŠ¨è®¾è®¡)æ¶æ„æ¨¡å¼ã€‚

## ğŸ¯ æ ¸å¿ƒç‰¹æ€§

### âœ… å®Œæ•´çš„RBACæ¨¡å‹
- **ç”¨æˆ·(User)** - ç³»ç»Ÿä½¿ç”¨è€…
- **è§’è‰²(Role)** - æƒé™çš„é›†åˆ
- **æƒé™(Permission)** - å…·ä½“çš„æ“ä½œè®¸å¯(resource:actionæ ¼å¼)
- **èœå•(Menu)** - æ”¯æŒåˆ†ç»„ã€ç›®å½•ã€èœå•ã€æŒ‰é’®å››ç§ç±»å‹

### âœ… çµæ´»çš„æƒé™æ§åˆ¶
- **èµ„æºçº§æƒé™**ï¼šåŸºäºresource:actionæ ¼å¼çš„ç»†ç²’åº¦æƒé™æ§åˆ¶
- **èœå•çº§æƒé™**ï¼šæ”¯æŒé¡µé¢è®¿é—®æ§åˆ¶
- **æŒ‰é’®çº§æƒé™**ï¼šæ”¯æŒé¡µé¢å†…åŠŸèƒ½æŒ‰é’®çš„æƒé™æ§åˆ¶
- **å±‚çº§èœå•**ï¼šæ”¯æŒæ— é™å±‚çº§çš„èœå•æ ‘ç»“æ„

### âœ… å®Œæ•´çš„APIæ¥å£
- **RESTfulè®¾è®¡**ï¼šç¬¦åˆRESTè§„èŒƒçš„APIè®¾è®¡
- **ç»Ÿä¸€å“åº”æ ¼å¼**ï¼šæ ‡å‡†åŒ–çš„APIå“åº”ç»“æ„
- **é”™è¯¯å¤„ç†**ï¼šå®Œå–„çš„é”™è¯¯å¤„ç†å’Œå“åº”æœºåˆ¶
- **å‚æ•°éªŒè¯**ï¼šè¯·æ±‚å‚æ•°çš„éªŒè¯å’Œç±»å‹æ£€æŸ¥

### âœ… ä¸­é—´ä»¶æ”¯æŒ
- **æƒé™ä¸­é—´ä»¶**ï¼šåŸºäºæƒé™çš„APIè®¿é—®æ§åˆ¶
- **è®¤è¯ä¸­é—´ä»¶**ï¼šJWTè®¤è¯æ”¯æŒ
- **æ—¥å¿—ä¸­é—´ä»¶**ï¼šè¯·æ±‚æ—¥å¿—è®°å½•
- **CORSä¸­é—´ä»¶**ï¼šè·¨åŸŸèµ„æºå…±äº«æ”¯æŒ

## ğŸ—ï¸ æ¶æ„è®¾è®¡

### åˆ†å±‚æ¶æ„
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              API Layer              â”‚  â† Handler + Router + Middleware
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚           Application Layer         â”‚  â† Service Registration
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚            Domain Layer             â”‚  â† Business Logic
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚    User     â”‚ â”‚      RBAC       â”‚ â”‚
â”‚  â”‚   Domain    â”‚ â”‚     Domain      â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚         Infrastructure Layer        â”‚  â† Repository Implementation
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚            Database Layer           â”‚  â† GORM + PostgreSQL
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ç›®å½•ç»“æ„
```
backend/
â”œâ”€â”€ domain/                    # é¢†åŸŸå±‚
â”‚   â”œâ”€â”€ user/                 # ç”¨æˆ·é¢†åŸŸ
â”‚   â””â”€â”€ rbac/                 # RBACé¢†åŸŸ
â”‚       â”œâ”€â”€ entity/           # å®ä½“
â”‚       â”œâ”€â”€ repository/       # ä»“å‚¨æ¥å£
â”‚       â””â”€â”€ service/          # é¢†åŸŸæœåŠ¡
â”œâ”€â”€ infra/                    # åŸºç¡€è®¾æ–½å±‚
â”‚   â”œâ”€â”€ config/              # é…ç½®
â”‚   â”œâ”€â”€ database/            # æ•°æ®åº“
â”‚   â””â”€â”€ repository/          # ä»“å‚¨å®ç°
â”œâ”€â”€ api/                     # APIå±‚
â”‚   â”œâ”€â”€ handler/            # å¤„ç†å™¨
â”‚   â”œâ”€â”€ middleware/         # ä¸­é—´ä»¶
â”‚   â”œâ”€â”€ model/             # APIæ¨¡å‹
â”‚   â””â”€â”€ router/            # è·¯ç”±
â”œâ”€â”€ application/            # åº”ç”¨å±‚
â”œâ”€â”€ pkg/                   # å·¥å…·åŒ…
â”œâ”€â”€ cmd/                   # å‘½ä»¤è¡Œå·¥å…·
â”‚   â””â”€â”€ init/             # æ•°æ®åˆå§‹åŒ–
â””â”€â”€ docs/                 # æ–‡æ¡£
```

## ğŸ“Š æ•°æ®åº“è®¾è®¡

### æ ¸å¿ƒè¡¨ç»“æ„

#### ç”¨æˆ·è¡¨ (users)
- id, username, password_hash, email, status
- created_at, updated_at

#### è§’è‰²è¡¨ (roles)
- id, name, code, description, status
- created_at, updated_at

#### æƒé™è¡¨ (permissions)
- id, name, code, resource, action, description, status
- created_at, updated_at

#### èœå•è¡¨ (menus)
- id, parent_id, name, code, path, type, order, status, meta
- created_at, updated_at

#### å…³è”è¡¨
- user_roles (ç”¨æˆ·è§’è‰²å…³è”)
- role_permissions (è§’è‰²æƒé™å…³è”)
- role_menus (è§’è‰²èœå•å…³è”)

## ğŸ”§ APIæ¥å£

### è§’è‰²ç®¡ç†
- `POST /api/v1/roles` - åˆ›å»ºè§’è‰²
- `GET /api/v1/roles/:id` - è·å–è§’è‰²
- `GET /api/v1/roles` - è§’è‰²åˆ—è¡¨
- `PUT /api/v1/roles/:id` - æ›´æ–°è§’è‰²
- `DELETE /api/v1/roles/:id` - åˆ é™¤è§’è‰²

### æƒé™ç®¡ç†
- `POST /api/v1/permissions` - åˆ›å»ºæƒé™
- `GET /api/v1/permissions/:id` - è·å–æƒé™
- `GET /api/v1/permissions` - æƒé™åˆ—è¡¨
- `PUT /api/v1/permissions/:id` - æ›´æ–°æƒé™
- `DELETE /api/v1/permissions/:id` - åˆ é™¤æƒé™

### èœå•ç®¡ç†
- `POST /api/v1/menus` - åˆ›å»ºèœå•
- `GET /api/v1/menus/:id` - è·å–èœå•
- `GET /api/v1/menus` - èœå•åˆ—è¡¨
- `GET /api/v1/menus/tree` - èœå•æ ‘
- `PUT /api/v1/menus/:id` - æ›´æ–°èœå•
- `DELETE /api/v1/menus/:id` - åˆ é™¤èœå•

### æƒé™åˆ†é…
- `POST /api/v1/users/:user_id/roles` - åˆ†é…ç”¨æˆ·è§’è‰²
- `POST /api/v1/roles/:role_id/permissions` - åˆ†é…è§’è‰²æƒé™
- `POST /api/v1/roles/:role_id/menus` - åˆ†é…è§’è‰²èœå•

### æƒé™æŸ¥è¯¢
- `GET /api/v1/users/:user_id/roles` - è·å–ç”¨æˆ·è§’è‰²
- `GET /api/v1/users/:user_id/permissions` - è·å–ç”¨æˆ·æƒé™
- `GET /api/v1/users/:user_id/menus/tree` - è·å–ç”¨æˆ·èœå•æ ‘
- `GET /api/v1/users/:user_id/permissions/check` - æ£€æŸ¥ç”¨æˆ·æƒé™

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. ç¯å¢ƒå‡†å¤‡
```bash
# å®‰è£…Go 1.19+
# å®‰è£…PostgreSQL
# å…‹éš†é¡¹ç›®
git clone <repository>
cd alice/backend
```

### 2. é…ç½®æ•°æ®åº“
```bash
# å¯åŠ¨PostgreSQLæ•°æ®åº“
make db-setup

# æˆ–è€…æ‰‹åŠ¨é…ç½®config.yamlä¸­çš„æ•°æ®åº“è¿æ¥
```

### 3. æ„å»ºå’Œè¿è¡Œ
```bash
# å®‰è£…ä¾èµ–
make deps

# æ„å»ºé¡¹ç›®
make build

# åˆå§‹åŒ–RBACæ•°æ®
make init-data

# è¿è¡Œåº”ç”¨
make run
```

### 4. æµ‹è¯•API
```bash
# åˆ›å»ºè§’è‰²
curl -X POST http://localhost:8080/api/v1/roles \
  -H "Content-Type: application/json" \
  -d '{"name": "ç®¡ç†å‘˜", "code": "admin"}'

# è·å–è§’è‰²åˆ—è¡¨
curl http://localhost:8080/api/v1/roles
```

## ğŸ“ ä½¿ç”¨ç¤ºä¾‹

### æƒé™ä¸­é—´ä»¶ä½¿ç”¨
```go
// åœ¨éœ€è¦æƒé™æ§åˆ¶çš„è·¯ç”±ä¸Šä½¿ç”¨
router.GET("/api/v1/users", 
    middleware.RequirePermission(permissionService, "user", "read"),
    userHandler.ListUsers)

router.POST("/api/v1/users", 
    middleware.RequirePermission(permissionService, "user", "create"),
    userHandler.CreateUser)
```

### å‰ç«¯æƒé™æ§åˆ¶
```javascript
// è·å–ç”¨æˆ·èœå•æ ‘
const menuTree = await fetch('/api/v1/users/current/menus/tree');

// æ£€æŸ¥æŒ‰é’®æƒé™
const hasPermission = await fetch('/api/v1/users/current/permissions/check?resource=user&action=delete');

// æ ¹æ®æƒé™æ˜¾ç¤º/éšè—æŒ‰é’®
if (hasPermission.data.has_permission) {
    showDeleteButton();
}
```

## ğŸ”’ å®‰å…¨ç‰¹æ€§

### 1. è®¤è¯æˆæƒ
- JWT Tokenè®¤è¯
- æƒé™ä¸­é—´ä»¶æ‹¦æˆª
- æœ€å°æƒé™åŸåˆ™

### 2. æ•°æ®å®‰å…¨
- å¯†ç å“ˆå¸Œå­˜å‚¨
- SQLæ³¨å…¥é˜²æŠ¤(GORM)
- å‚æ•°éªŒè¯

### 3. APIå®‰å…¨
- CORSé…ç½®
- è¯·æ±‚æ—¥å¿—è®°å½•
- é”™è¯¯ä¿¡æ¯è¿‡æ»¤

## ğŸ¯ æœ€ä½³å®è·µ

### 1. æƒé™è®¾è®¡
- ä½¿ç”¨resource:actionæ ¼å¼å®šä¹‰æƒé™
- éµå¾ªæœ€å°æƒé™åŸåˆ™
- å®šæœŸå®¡æŸ¥æƒé™åˆ†é…

### 2. èœå•è®¾è®¡
- åˆç†è®¾è®¡èœå•å±‚çº§
- ä½¿ç”¨è¯­ä¹‰åŒ–çš„èœå•ä»£ç 
- æŒ‰é’®æƒé™ä¸èœå•æƒé™åˆ†ç¦»

### 3. è§’è‰²è®¾è®¡
- åŸºäºä¸šåŠ¡èŒèƒ½è®¾è®¡è§’è‰²
- é¿å…æƒé™é‡å¤åˆ†é…
- å®šæœŸæ¸…ç†æ— ç”¨è§’è‰²

## ğŸš§ æ‰©å±•æ€§

### 1. å¤šç§Ÿæˆ·æ”¯æŒ
å¯æ‰©å±•æ”¯æŒå¤šç§Ÿæˆ·æ¶æ„ï¼Œæ¯ä¸ªç§Ÿæˆ·æœ‰ç‹¬ç«‹çš„æƒé™ä½“ç³»ã€‚

### 2. æƒé™ç¼“å­˜
å¯é›†æˆRedisç¼“å­˜æƒé™ä¿¡æ¯ï¼Œæé«˜æŸ¥è¯¢æ€§èƒ½ã€‚

### 3. å®¡è®¡æ—¥å¿—
å¯æ‰©å±•å®¡è®¡æ—¥å¿—åŠŸèƒ½ï¼Œè®°å½•æ‰€æœ‰æƒé™å˜æ›´æ“ä½œã€‚

### 4. å·¥ä½œæµé›†æˆ
å¯ä¸å·¥ä½œæµç³»ç»Ÿé›†æˆï¼Œæ”¯æŒæƒé™ç”³è¯·å®¡æ‰¹æµç¨‹ã€‚

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–

### 1. æ•°æ®åº“ä¼˜åŒ–
- åœ¨å…³è”è¡¨å¤–é”®ä¸Šå»ºç«‹ç´¢å¼•
- åˆç†ä½¿ç”¨æ•°æ®åº“è¿æ¥æ± 
- æŸ¥è¯¢ä¼˜åŒ–å’Œæ…¢æŸ¥è¯¢ç›‘æ§

### 2. ç¼“å­˜ç­–ç•¥
- èœå•æ ‘ç»“æ„ç¼“å­˜
- ç”¨æˆ·æƒé™ä¿¡æ¯ç¼“å­˜
- è§’è‰²æƒé™æ˜ å°„ç¼“å­˜

### 3. APIä¼˜åŒ–
- åˆ†é¡µæŸ¥è¯¢æ”¯æŒ
- æ‰¹é‡æ“ä½œæ¥å£
- å“åº”æ•°æ®å‹ç¼©

## ğŸ§ª æµ‹è¯•

### å•å…ƒæµ‹è¯•
```bash
make test
```

### APIæµ‹è¯•
```bash
# ä½¿ç”¨æä¾›çš„APIç¤ºä¾‹è¿›è¡Œæµ‹è¯•
# å‚è€ƒdocs/API_EXAMPLES.md
```

### é›†æˆæµ‹è¯•
```bash
make test-coverage
```

## ğŸ“š æ–‡æ¡£

- [RBACç³»ç»Ÿè®¾è®¡æ–‡æ¡£](docs/RBAC.md)
- [APIä½¿ç”¨ç¤ºä¾‹](docs/API_EXAMPLES.md)
- [æ¶æ„è®¾è®¡æ–‡æ¡£](docs/architecture.md)

## ğŸ¤ è´¡çŒ®

1. Fork é¡¹ç›®
2. åˆ›å»ºç‰¹æ€§åˆ†æ”¯
3. æäº¤å˜æ›´
4. æ¨é€åˆ°åˆ†æ”¯
5. åˆ›å»º Pull Request

## ğŸ“„ è®¸å¯è¯

Apache License 2.0

## ğŸ’¡ æ€»ç»“

è¿™ä¸ªRBACæƒé™ç®¡ç†ç³»ç»Ÿæä¾›äº†ï¼š

1. **å®Œæ•´çš„æƒé™æ¨¡å‹**ï¼šæ”¯æŒç”¨æˆ·ã€è§’è‰²ã€æƒé™ã€èœå•çš„å®Œæ•´å…³è”
2. **ç²¾ç¡®çš„æƒé™æ§åˆ¶**ï¼šå¯ä»¥ç²¾ç¡®åˆ°é¡µé¢æŒ‰é’®çº§åˆ«çš„æƒé™
3. **æ¸…æ™°çš„æ¶æ„è®¾è®¡**ï¼šä¸¥æ ¼éµå¾ªDDDåˆ†å±‚æ¶æ„
4. **ä¸°å¯Œçš„APIæ¥å£**ï¼šæä¾›å®Œæ•´çš„RESTful API
5. **è‰¯å¥½çš„æ‰©å±•æ€§**ï¼šä¾¿äºåç»­åŠŸèƒ½æ‰©å±•å’Œä¼˜åŒ–
6. **å®Œå–„çš„æ–‡æ¡£**ï¼šæä¾›è¯¦ç»†çš„ä½¿ç”¨æ–‡æ¡£å’Œç¤ºä¾‹

è¯¥ç³»ç»Ÿå¯ä»¥ç›´æ¥ç”¨äºä¼ä¸šçº§åº”ç”¨çš„æƒé™ç®¡ç†ï¼Œä¹Ÿå¯ä»¥ä½œä¸ºRBACç³»ç»Ÿçš„å‚è€ƒå®ç°ã€‚
